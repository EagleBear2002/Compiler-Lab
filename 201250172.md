# 编译原理 Lab6 实验报告

姓名：熊丘桓

学号：201250127

邮箱：<eaglebear@smail.nju.edu.cn>

## 实现功能

本次实验完成了以下功能：

1. 全局变量声明和使用
1. 条件语句

## 实验设计

本次实验重新设计了 `LLVMVisitor` 类，其中全局变量相关内容主要是对 `visitVarDecl` 方法的修改：

```java
@Override
public LLVMValueRef visitVarDecl(SysYParser.VarDeclContext ctx) {
    String typeName = ctx.bType().getText();

    for (SysYParser.VarDefContext varDefContext : ctx.varDef()) {
        LLVMTypeRef varType = getTypeRef(typeName);
        String varName = varDefContext.IDENT().getText();
        int elementCount = 0;

        for (SysYParser.ConstExpContext constExpContext : varDefContext.constExp()) {
            elementCount = Integer.parseInt(toDecimalInteger(constExpContext.getText()));
            varType = LLVMArrayType(varType, elementCount);
        }

        LLVMValueRef varPointer = null;
        if (currentScope == globalScope) {
            varPointer = LLVMAddGlobal(module, varType, "pointer_" + varName);
            if (elementCount == 0) {
                LLVMSetInitializer(varPointer, zero);
            } else {
                PointerPointer<Pointer> pointerPointer = new PointerPointer<>(elementCount);
                for (int i = 0; i < elementCount; ++i) {
                    pointerPointer.put(i, zero);
                }
                LLVMValueRef initArray = LLVMConstArray(varType, pointerPointer, elementCount);
                LLVMSetInitializer(varPointer, initArray);
            }
        } else {
            varPointer = LLVMBuildAlloca(builder, varType, "pointer_" + varName);
        }

        if (varDefContext.ASSIGN() != null) {
            SysYParser.ExpContext expContext = varDefContext.initVal().exp();
            if (expContext != null) {
                LLVMValueRef initVal = visit(expContext);
                if (currentScope == globalScope) {
                    LLVMSetInitializer(varPointer, initVal);
                } else {
                    LLVMBuildStore(builder, initVal, varPointer);
                }
            } else {
                int initValCount = varDefContext.initVal().initVal().size();
                if (currentScope == globalScope) {
                    PointerPointer<Pointer> pointerPointer = new PointerPointer<>(elementCount);
                    for (int i = 0; i < elementCount; ++i) {
                        if (i < initValCount) {
                            pointerPointer.put(i, this.visit(varDefContext.initVal().initVal(i).exp()));
                        } else {
                            pointerPointer.put(i, zero);
                        }
                    }
                    LLVMValueRef initArray = LLVMConstArray(varType, pointerPointer, elementCount);
                    LLVMSetInitializer(varPointer, initArray);
                } else {
                    LLVMValueRef[] initArray = new LLVMValueRef[elementCount];
                    for (int i = 0; i < elementCount; ++i) {
                        if (i < initValCount) {
                            initArray[i] = this.visit(varDefContext.initVal().initVal(i).exp());
                        } else {
                            initArray[i] = LLVMConstInt(i32Type, 0, 0);
                        }
                    }
                    buildGEP(elementCount, varPointer, initArray);
                }
            }
        }

        currentScope.define(varName, varPointer);
    }

    return null;
}
```

## 实验困难

笔者实验过程中仍有三个困难的测试用例无法解决，报错信息如下：

```
hardtest1.sy：0（Aborted (core dumped) ）
hardtest2.sy：0（Aborted (core dumped) ）
hardtest3.sy：0（Aborted (core dumped) ）
```

